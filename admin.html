<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin 2.0 - Envases La Económica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <!-- Iconos para mejorar la UI -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Animación suave para filas */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { bg: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }
    </style>
</head>
<body class="bg-gray-100 p-2 md:p-6 font-sans text-slate-800 h-screen flex flex-col overflow-hidden">
    
    <!-- 1. PANTALLA DE CARGA -->
    <div id="loader" class="fixed inset-0 bg-slate-900 z-[60] flex flex-col items-center justify-center text-white transition-opacity duration-500">
        <div class="animate-spin h-12 w-12 border-4 border-indigo-500 border-t-transparent rounded-full mb-4"></div>
        <p class="text-sm tracking-widest uppercase font-semibold animate-pulse">Cargando Sistema...</p>
    </div>

    <!-- 2. CONTENIDO PRINCIPAL (Flex Column para ocupar toda la altura) -->
    <div id="main-content" class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl border border-gray-200 hidden flex-col h-full w-full">
        
        <!-- HEADER -->
        <div class="bg-indigo-900 p-4 md:p-6 flex flex-col md:flex-row justify-between items-center gap-4 shrink-0">
            <div class="flex items-center gap-4">
                <div class="bg-indigo-700 p-3 rounded-lg text-white">
                    <i class="fa-solid fa-boxes-stacked text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-white text-xl md:text-2xl font-bold tracking-tight">Panel de Inventario</h1>
                    <div class="flex items-center gap-2 text-indigo-200 text-xs">
                        <i class="fa-solid fa-user-shield"></i>
                        <span id="user-info">Cargando usuario...</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="hidden md:flex flex-col items-end mr-4">
                    <span id="total-count" class="text-white font-bold text-lg">0</span>
                    <span class="text-indigo-300 text-xs uppercase">Productos</span>
                </div>
                <button onclick="logout()" class="text-xs bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition shadow-lg flex items-center gap-2">
                    <i class="fa-solid fa-right-from-bracket"></i> Salir
                </button>
            </div>
        </div>

        <!-- FORMULARIO DE AGREGAR (Collapsible) -->
        <div class="border-b bg-gray-50 shrink-0">
            <details class="group p-4" open>
                <summary class="list-none flex justify-between items-center cursor-pointer mb-2">
                    <h2 class="font-bold text-indigo-800 uppercase text-xs tracking-wider flex items-center gap-2">
                        <i class="fa-solid fa-circle-plus text-indigo-500"></i> Agregar Nuevo Producto
                    </h2>
                    <span class="text-xs text-gray-400 group-open:rotate-180 transition-transform"><i class="fa-solid fa-chevron-down"></i></span>
                </summary>
                
                <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end animate-in fade-in zoom-in-95 duration-200">
                    <div class="col-span-1 md:col-span-2 space-y-1">
                        <label class="text-[10px] text-gray-500 font-bold uppercase ml-1">Nombre del Producto</label>
                        <input id="prodName" type="text" placeholder="Ej. Botella PET 1L" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 text-sm outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] text-gray-500 font-bold uppercase ml-1">Categoría</label>
                        <input id="prodCat" type="text" placeholder="Ej. Plásticos" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 text-sm outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] text-gray-500 font-bold uppercase ml-1">Piezas x Paq.</label>
                        <input id="prodPcs" type="number" placeholder="Ej. 50" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 text-sm outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] text-gray-500 font-bold uppercase ml-1">Ubicación</label>
                        <input id="prodLoc" type="text" placeholder="Ej. A-12" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 text-sm outline-none">
                    </div>
                    
                    <!-- Input Imagen Inteligente -->
                    <div class="col-span-1 md:col-span-6 flex gap-3 items-end pt-2">
                         <div class="flex-grow space-y-1 relative">
                            <label class="text-[10px] text-gray-500 font-bold uppercase ml-1">URL Imagen</label>
                            <input id="prodFile" oninput="previewImage(this.value)" type="text" placeholder="https://..." class="w-full p-2 pl-8 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 text-sm outline-none">
                            <i class="fa-solid fa-link absolute left-3 top-8 text-gray-400 text-xs"></i>
                        </div>
                        <div id="imgPreviewBox" class="w-10 h-10 bg-gray-200 rounded border border-gray-300 flex items-center justify-center overflow-hidden hidden">
                            <img id="imgPreview" class="w-full h-full object-cover">
                        </div>
                        <button onclick="uploadProduct()" id="btnUpload" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded hover:bg-indigo-700 transition shadow-md flex items-center gap-2 whitespace-nowrap h-10">
                            <i class="fa-solid fa-save"></i> Guardar
                        </button>
                    </div>
                </div>
            </details>
        </div>

        <!-- BARRA DE HERRAMIENTAS TABLA -->
        <div class="p-3 bg-white border-b flex flex-col sm:flex-row justify-between items-center gap-3 shrink-0 z-10">
            <div class="relative w-full sm:w-96">
                <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
                <input id="searchInput" onkeyup="filterProducts()" type="text" placeholder="Buscar por nombre, SKU o categoría..." 
                    class="w-full pl-10 pr-4 py-2 bg-gray-100 border-transparent focus:bg-white focus:ring-2 focus:ring-indigo-200 rounded-lg text-sm transition-all outline-none">
            </div>
            <div class="flex gap-2">
                <button onclick="loadProducts()" class="text-gray-500 hover:text-indigo-600 p-2 rounded-full hover:bg-gray-100 transition" title="Refrescar">
                    <i class="fa-solid fa-arrows-rotate"></i>
                </button>
            </div>
        </div>

        <!-- TABLA CON SCROLL INDEPENDIENTE -->
        <div class="flex-grow overflow-auto bg-gray-50 relative">
            <table class="w-full text-left border-collapse min-w-[800px]">
                <thead class="bg-white text-xs uppercase text-gray-500 font-semibold tracking-wider sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="p-4 w-20 text-center bg-white">Img</th>
                        <th class="p-4 bg-white">Producto / Categoría</th>
                        <th class="p-4 w-32 bg-white">Piezas</th>
                        <th class="p-4 w-32 bg-white">Ubicación</th>
                        <th class="p-4 w-24 text-center bg-white">Visible</th>
                        <th class="p-4 w-20 text-right bg-white">Acción</th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="divide-y divide-gray-200 text-sm text-gray-700 bg-white">
                    <!-- Los productos se inyectan aquí -->
                </tbody>
            </table>
            
            <!-- Estado Vacío -->
            <div id="emptyState" class="hidden flex flex-col items-center justify-center h-64 text-gray-400">
                <i class="fa-solid fa-box-open text-4xl mb-3"></i>
                <p>No se encontraron productos</p>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed bottom-6 right-6 bg-slate-800 text-white px-6 py-4 rounded-lg shadow-2xl translate-y-24 transition-transform duration-300 z-[100] border-l-4 border-indigo-500 flex items-center gap-3">
        <i id="toast-icon" class="fa-solid fa-check-circle text-green-400"></i>
        <div>
            <h4 id="toast-title" class="font-bold text-sm">Notificación</h4>
            <p id="toast-msg" class="text-xs text-slate-300">Mensaje del sistema</p>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN (Tus credenciales originales)
        const firebaseConfig = {
            apiKey: "AIzaSyDkQ2HcaLHY7dPvg_IRmuiZNGtcfUhu05o",
            authDomain: "productoseen.firebaseapp.com",
            databaseURL: "https://productoseen-default-rtdb.firebaseio.com",
            projectId: "productoseen",
            storageBucket: "productoseen.firebasestorage.app",
            messagingSenderId: "1052892398028",
            appId: "1:1052892398028:web:055e67f2aa4bce0d9c9d69"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        let currentUser = null;
        let allProducts = []; // Almacenamiento local para búsqueda rápida

        // --- AUTH & INICIALIZACIÓN ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user; 
                try {
                    // Verificación de permisos (Igual que tu código original)
                    const snap = await db.ref('usuarios_permisos/' + user.uid).once('value');
                    if (snap.exists() && snap.val().redireccion === "admin.html") {
                        document.getElementById('user-info').innerText = user.email.split('@')[0]; // Mostrar solo nombre
                        document.getElementById('loader').classList.add('opacity-0', 'pointer-events-none'); // Fade out loader
                        document.getElementById('main-content').classList.remove('hidden');
                        document.getElementById('main-content').classList.add('flex');
                        
                        setupRealtimeListener(); 
                    } else {
                        throw new Error("Permisos insuficientes.");
                    }
                } catch (error) {
                    alert("Acceso denegado: " + error.message);
                    window.location.href = "login.html"; 
                }
            } else {
                window.location.href = "login.html";
            }
        });

        async function logout() {
            await auth.signOut();
            window.location.href = "login.html";
        }

        // --- LÓGICA DE DATOS OPTIMIZADA ---
        function setupRealtimeListener() {
            const productsRef = db.ref('productos');
            
            // Escuchar cambios. Almacenamos todo en 'allProducts' y luego renderizamos
            productsRef.orderByChild('createdAt').on('value', (snapshot) => {
                allProducts = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        allProducts.push({id: child.key, ...child.val()});
                    });
                    // Orden descendente por fecha
                    allProducts.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                }
                
                document.getElementById('total-count').innerText = allProducts.length;
                filterProducts(); // Renderiza usando el filtro actual (o todo si está vacío)
            }, (error) => {
                showToast("Error de conexión", error.message, "error");
            });
        }

        // Función de filtrado (Búsqueda local instantánea)
        window.filterProducts = () => {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allProducts.filter(p => 
                (p.name || '').toLowerCase().includes(term) ||
                (p.category || '').toLowerCase().includes(term) ||
                (p.ubicacion || '').toLowerCase().includes(term)
            );
            renderTable(filtered);
        }

        // Renderizado de tabla
        function renderTable(products) {
            const tbody = document.getElementById('tableBody');
            const emptyState = document.getElementById('emptyState');
            tbody.innerHTML = "";

            if (products.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            products.forEach(p => {
                const isActive = p.activo !== false; 
                
                const tr = document.createElement('tr');
                tr.className = `group hover:bg-indigo-50 transition-colors border-b border-gray-100 ${!isActive ? 'opacity-60 bg-gray-50' : ''} fade-in`;
                
                tr.innerHTML = `
                    <td class="p-3 text-center">
                        <div class="relative group/img w-10 h-10 mx-auto">
                            <img src="${p.image}" class="w-10 h-10 object-cover rounded shadow-sm bg-white border cursor-pointer" 
                                onerror="this.src='https://via.placeholder.com/100?text=IMG'"
                                onclick="window.open('${p.image}', '_blank')">
                        </div>
                    </td>
                    <td class="p-3">
                        <input onchange="updateProduct('${p.id}','name',this.value, this)" value="${p.name || ''}" class="block w-full text-sm font-medium text-gray-900 bg-transparent border-b border-transparent focus:border-indigo-500 outline-none transition placeholder-gray-400 mb-1" placeholder="Nombre...">
                        <input onchange="updateProduct('${p.id}','category',this.value, this)" value="${p.category || ''}" class="block w-full text-xs text-indigo-600 font-mono bg-transparent border-b border-transparent focus:border-indigo-500 outline-none transition placeholder-gray-300" placeholder="Categoría...">
                    </td>
                    <td class="p-3 align-top">
                        <input type="number" onchange="updateProduct('${p.id}','piezas',this.value, this)" value="${p.piezas || ''}" class="w-full bg-transparent p-1 border border-gray-200 rounded text-center focus:bg-white focus:border-indigo-500 outline-none text-xs" placeholder="-">
                    </td>
                     <td class="p-3 align-top">
                        <input type="text" onchange="updateProduct('${p.id}','ubicacion',this.value, this)" value="${p.ubicacion || ''}" class="w-full bg-transparent p-1 border border-gray-200 rounded text-center focus:bg-white focus:border-indigo-500 outline-none text-xs" placeholder="-">
                    </td>
                    <td class="p-3 text-center align-middle">
                         <label class="inline-flex items-center cursor-pointer relative group/toggle" title="Activar/Desactivar">
                            <input type="checkbox" onchange="updateProduct('${p.id}', 'activo', this.checked)" class="sr-only peer" ${isActive ? 'checked' : ''}>
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500"></div>
                        </label>
                    </td>
                    <td class="p-3 text-right align-middle">
                        <button onclick="deleteProduct('${p.id}')" class="text-gray-300 hover:text-red-500 p-2 transition transform hover:scale-110" title="Eliminar">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- PREVIEW IMAGEN ---
        window.previewImage = (url) => {
            const box = document.getElementById('imgPreviewBox');
            const img = document.getElementById('imgPreview');
            if(url && url.length > 10) {
                box.classList.remove('hidden');
                img.src = url;
                img.onerror = () => box.classList.add('hidden');
            } else {
                box.classList.add('hidden');
            }
        }

        // --- CRUD MEJORADO ---
        async function uploadProduct() {
            if (!currentUser) return showToast("Error", "Sesión inválida", "error");
            
            const name = document.getElementById('prodName').value;
            const cat = document.getElementById('prodCat').value;
            const url = document.getElementById('prodFile').value;
            const pcs = document.getElementById('prodPcs').value; // Nuevo
            const loc = document.getElementById('prodLoc').value; // Nuevo
            const btn = document.getElementById('btnUpload');
            
            if(!name || !url) return showToast("Faltan datos", "El nombre y la imagen son obligatorios", "error");
            
            // UI Loading
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Guardando...`;

            try {
                await db.ref('productos').push({
                    name, 
                    category: cat, 
                    image: url,
                    piezas: pcs, // Guardar piezas
                    ubicacion: loc, // Guardar ubicación
                    activo: true, 
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
                showToast("Éxito", "Producto agregado correctamente", "success");
                
                // Limpiar campos
                document.getElementById('prodName').value = "";
                document.getElementById('prodCat').value = "";
                document.getElementById('prodFile').value = "";
                document.getElementById('prodPcs').value = "";
                document.getElementById('prodLoc').value = "";
                document.getElementById('imgPreviewBox').classList.add('hidden');
            } catch(e) { 
                showToast("Error", e.message, "error"); 
            } finally { 
                btn.disabled = false; 
                btn.innerHTML = originalText; 
            }
        }

        // Actualización inteligente (con feedback en el input)
        window.updateProduct = async (id, field, val, inputElement) => {
            if(!currentUser) return;
            
            // Feedback visual inmediato en el input (si se proporcionó)
            let originalBorder = "";
            if(inputElement) {
                originalBorder = inputElement.className;
                inputElement.classList.add('border-yellow-400', 'bg-yellow-50');
            }

            try {
                await db.ref('productos/'+id).update({[field]: val});
                
                // Feedback de éxito
                if(inputElement) {
                    inputElement.classList.remove('border-yellow-400', 'bg-yellow-50');
                    inputElement.classList.add('border-green-400', 'bg-green-50');
                    setTimeout(() => {
                        inputElement.classList.remove('border-green-400', 'bg-green-50');
                    }, 1000);
                }
                
                // Solo mostramos toast para cambios críticos (como el toggle activo)
                if(field === 'activo') showToast("Actualizado", "Visibilidad del producto cambiada", "success");

            } catch(e) { 
                showToast("Error", "No se pudo actualizar", "error");
                if(inputElement) inputElement.classList.add('border-red-500');
            }
        };

        window.deleteProduct = async (id) => {
            if(!currentUser) return;
            // Usamos confirm nativo pero con texto más claro
            if(confirm("⚠️ ¿Estás seguro de eliminar este producto?\n\nEsta acción no se puede deshacer.")) {
                try {
                    await db.ref('productos/'+id).remove();
                    showToast("Eliminado", "El producto ha sido borrado", "success");
                } catch(e) { showToast("Error", e.message, "error"); }
            }
        };

        // Sistema de notificaciones (Toasts)
        let toastTimeout;
        function showToast(title, msg, type = "success") {
            const t = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            
            document.getElementById('toast-title').innerText = title;
            document.getElementById('toast-msg').innerText = msg;
            
            // Colores según tipo
            if(type === 'error') {
                t.classList.replace('border-indigo-500', 'border-red-500');
                icon.className = "fa-solid fa-circle-exclamation text-red-500 text-xl";
            } else {
                t.classList.replace('border-red-500', 'border-indigo-500');
                icon.className = "fa-solid fa-check-circle text-green-400 text-xl";
            }

            t.classList.remove('translate-y-24');
            
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => t.classList.add('translate-y-24'), 3000);
        }

        window.uploadProduct = uploadProduct;
    </script>
</body>
</html>
