<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin 2.0 - Envases La Económica del Norte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <!-- Iconos para mejorar la UI -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Animación suave para filas */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        /* Scrollbar personalizada fina */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { bg: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }
        
        /* Ajuste para inputs compactos */
        .input-compact { padding-top: 2px; padding-bottom: 2px; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-slate-800 h-screen flex flex-col overflow-hidden text-xs md:text-sm">
    
    <!-- 1. PANTALLA DE CARGA -->
    <div id="loader" class="fixed inset-0 bg-slate-900 z-[60] flex flex-col items-center justify-center text-white transition-opacity duration-500">
        <div class="animate-spin h-12 w-12 border-4 border-indigo-500 border-t-transparent rounded-full mb-4"></div>
        <p class="text-xs tracking-widest uppercase font-semibold animate-pulse">Cargando Sistema...</p>
    </div>

    <!-- 2. CONTENIDO PRINCIPAL (Flex Column para ocupar toda la altura) -->
    <div id="main-content" class="max-w-full mx-auto bg-white shadow-2xl border-x border-gray-200 hidden flex-col h-full w-full">
        
        <!-- HEADER COMPACTO -->
        <div class="bg-indigo-900 px-4 py-2 flex justify-between items-center shrink-0 h-14">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-700 p-1.5 rounded text-white">
                    <i class="fa-solid fa-boxes-stacked text-lg"></i>
                </div>
                <div>
                    <h1 class="text-white text-base font-bold tracking-tight leading-tight">Administración de catálogo de productos</h1>
                    <div class="flex items-center gap-1 text-indigo-200 text-[10px]">
                        <i class="fa-solid fa-user-shield"></i>
                        <span id="user-info">...</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="hidden md:flex flex-col items-end mr-2">
                    <span id="total-count" class="text-white font-bold text-base leading-none">0</span>
                    <span class="text-indigo-300 text-[9px] uppercase">Prod.</span>
                </div>
                <button onclick="logout()" class="text-[10px] bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded transition shadow flex items-center gap-1">
                    <i class="fa-solid fa-right-from-bracket"></i> Salir
                </button>
            </div>
        </div>

        <!-- FORMULARIO DE AGREGAR (Más compacto) -->
        <div class="border-b bg-gray-50 shrink-0">
            <details class="group px-4 py-2" open>
                <summary class="list-none flex justify-between items-center cursor-pointer mb-1 outline-none">
                    <h2 class="font-bold text-indigo-800 uppercase text-[10px] tracking-wider flex items-center gap-2 hover:text-indigo-600">
                        <i class="fa-solid fa-circle-plus"></i> Agregar Nuevo
                    </h2>
                    <span class="text-[10px] text-gray-400 group-open:rotate-180 transition-transform"><i class="fa-solid fa-chevron-down"></i></span>
                </summary>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-2 items-end animate-in fade-in zoom-in-95 duration-200 pb-1">
                    <div class="col-span-1 md:col-span-3 space-y-0.5">
                        <input id="prodName" type="text" placeholder="Nombre Producto" class="w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-indigo-500 text-xs outline-none">
                    </div>
                    <div class="col-span-1 md:col-span-2 space-y-0.5">
                        <input id="prodCat" type="text" placeholder="Categoría" class="w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-indigo-500 text-xs outline-none">
                    </div>
                    <div class="col-span-1 md:col-span-1 space-y-0.5">
                        <input id="prodPcs" type="number" placeholder="Pzas x Paq" class="w-full px-2 py-1.5 border border-gray-300 rounded focus:ring-1 focus:ring-indigo-500 text-xs outline-none" title="Piezas por Paquete/Bolsa">
                    </div>
                    
                    <!-- Input Imagen Integrado -->
                    <div class="col-span-1 md:col-span-5 flex gap-2 items-center">
                        <div class="flex-grow relative">
                            <input id="prodFile" oninput="previewImage(this.value)" type="text" placeholder="URL Imagen..." class="w-full px-2 py-1.5 pl-6 border border-gray-300 rounded focus:ring-1 focus:ring-indigo-500 text-xs outline-none">
                            <i class="fa-solid fa-link absolute left-2 top-2 text-gray-400 text-[10px]"></i>
                        </div>
                        <div id="imgPreviewBox" class="w-7 h-7 bg-gray-200 rounded border border-gray-300 flex-shrink-0 flex items-center justify-center overflow-hidden hidden">
                            <img id="imgPreview" class="w-full h-full object-cover">
                        </div>
                        <button onclick="uploadProduct()" id="btnUpload" class="bg-indigo-600 text-white font-bold py-1.5 px-3 rounded hover:bg-indigo-700 transition shadow text-xs flex items-center gap-1 whitespace-nowrap h-8">
                            <i class="fa-solid fa-save"></i>
                        </button>
                    </div>
                </div>
            </details>
        </div>

        <!-- BARRA DE HERRAMIENTAS TABLA -->
        <div class="px-4 py-2 bg-white border-b flex flex-row justify-between items-center gap-3 shrink-0 z-10 h-10">
            <div class="relative w-full max-w-md">
                <i class="fa-solid fa-search absolute left-2 top-2 text-gray-400 text-xs"></i>
                <input id="searchInput" onkeyup="filterProducts()" type="text" placeholder="Buscar..." 
                    class="w-full pl-7 pr-4 py-1 bg-gray-100 border-transparent focus:bg-white focus:ring-1 focus:ring-indigo-200 rounded text-xs transition-all outline-none h-7">
            </div>
            <div class="flex gap-2">
                <button onclick="loadProducts()" class="text-gray-400 hover:text-indigo-600 p-1 rounded hover:bg-gray-50 transition" title="Refrescar">
                    <i class="fa-solid fa-arrows-rotate text-xs"></i>
                </button>
            </div>
        </div>

        <!-- TABLA CON SCROLL INDEPENDIENTE -->
        <div class="flex-grow overflow-auto bg-gray-50 relative">
            <table class="w-full text-left border-collapse min-w-[600px]">
                <thead class="bg-white text-[10px] uppercase text-gray-500 font-bold tracking-wider sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="py-2 px-2 w-12 text-center bg-white border-b">Img</th>
                        <th class="py-2 px-2 bg-white border-b">Descripción</th>
                        <th class="py-2 px-2 w-24 text-center bg-white border-b">Pzas x Paq</th>
                        <th class="py-2 px-2 w-16 text-center bg-white border-b">Visible</th>
                        <th class="py-2 px-2 w-12 text-center bg-white border-b"></th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="divide-y divide-gray-200 text-xs text-gray-700 bg-white">
                    <!-- Los productos se inyectan aquí -->
                </tbody>
            </table>
            
            <!-- Estado Vacío -->
            <div id="emptyState" class="hidden flex flex-col items-center justify-center h-40 text-gray-400">
                <i class="fa-solid fa-filter text-2xl mb-2"></i>
                <p class="text-xs">Sin resultados</p>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION COMPACTA -->
    <div id="toast" class="fixed bottom-4 right-4 bg-slate-800 text-white px-4 py-2 rounded shadow-xl translate-y-24 transition-transform duration-300 z-[100] border-l-4 border-indigo-500 flex items-center gap-3">
        <i id="toast-icon" class="fa-solid fa-check text-green-400"></i>
        <div>
            <p id="toast-msg" class="text-xs font-medium text-slate-200">Mensaje</p>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN (Tus credenciales originales)
        const firebaseConfig = {
            apiKey: "AIzaSyDkQ2HcaLHY7dPvg_IRmuiZNGtcfUhu05o",
            authDomain: "productoseen.firebaseapp.com",
            databaseURL: "https://productoseen-default-rtdb.firebaseio.com",
            projectId: "productoseen",
            storageBucket: "productoseen.firebasestorage.app",
            messagingSenderId: "1052892398028",
            appId: "1:1052892398028:web:055e67f2aa4bce0d9c9d69"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        let currentUser = null;
        let allProducts = []; 

        // --- AUTH & INICIALIZACIÓN ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user; 
                try {
                    const snap = await db.ref('usuarios_permisos/' + user.uid).once('value');
                    if (snap.exists() && snap.val().redireccion === "admin.html") {
                        document.getElementById('user-info').innerText = user.email.split('@')[0];
                        document.getElementById('loader').classList.add('opacity-0', 'pointer-events-none');
                        document.getElementById('main-content').classList.remove('hidden');
                        document.getElementById('main-content').classList.add('flex');
                        setupRealtimeListener(); 
                    } else { throw new Error("Permisos insuficientes."); }
                } catch (error) {
                    alert("Acceso denegado: " + error.message);
                    window.location.href = "login.html"; 
                }
            } else { window.location.href = "login.html"; }
        });

        async function logout() {
            await auth.signOut();
            window.location.href = "login.html";
        }

        // --- LÓGICA ---
        function setupRealtimeListener() {
            const productsRef = db.ref('productos');
            productsRef.orderByChild('createdAt').on('value', (snapshot) => {
                allProducts = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        allProducts.push({id: child.key, ...child.val()});
                    });
                    allProducts.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                }
                document.getElementById('total-count').innerText = allProducts.length;
                filterProducts(); 
            }, (error) => showToast("Error de conexión", "error"));
        }

        window.filterProducts = () => {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allProducts.filter(p => 
                (p.name || '').toLowerCase().includes(term) ||
                (p.category || '').toLowerCase().includes(term)
            );
            renderTable(filtered);
        }

        function renderTable(products) {
            const tbody = document.getElementById('tableBody');
            const emptyState = document.getElementById('emptyState');
            tbody.innerHTML = "";

            if (products.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            products.forEach(p => {
                const isActive = p.activo !== false; 
                const tr = document.createElement('tr');
                // Filas compactas con hover suave
                tr.className = `group hover:bg-indigo-50 transition-colors border-b border-gray-100 ${!isActive ? 'opacity-50 bg-gray-50' : ''} fade-in`;
                
                tr.innerHTML = `
                    <td class="p-1 text-center align-middle">
                        <div class="w-8 h-8 mx-auto bg-white rounded border border-gray-200 overflow-hidden cursor-pointer hover:scale-150 transition-transform origin-left z-10 relative">
                            <img src="${p.image}" class="w-full h-full object-cover" 
                                onerror="this.src='https://via.placeholder.com/100?text=IMG'"
                                onclick="window.open('${p.image}', '_blank')">
                        </div>
                    </td>
                    <td class="p-1 align-middle">
                        <input onchange="updateProduct('${p.id}','name',this.value, this)" value="${p.name || ''}" class="block w-full font-semibold text-gray-900 bg-transparent border-none focus:bg-white focus:ring-1 focus:ring-indigo-200 rounded px-1 py-0.5 outline-none transition placeholder-gray-400 text-xs" placeholder="Nombre...">
                        <input onchange="updateProduct('${p.id}','category',this.value, this)" value="${p.category || ''}" class="block w-full text-[10px] text-indigo-600 font-mono bg-transparent border-none focus:bg-white focus:ring-1 focus:ring-indigo-200 rounded px-1 py-0 outline-none transition placeholder-gray-300 mt-0.5" placeholder="Categoría...">
                    </td>
                    <td class="p-1 align-middle text-center">
                        <input type="number" onchange="updateProduct('${p.id}','piezas',this.value, this)" value="${p.piezas || ''}" class="w-20 mx-auto bg-transparent border border-gray-100 rounded text-center focus:bg-white focus:border-indigo-500 outline-none text-xs py-0.5" placeholder="Pzas">
                    </td>
                    <td class="p-1 text-center align-middle">
                         <label class="inline-flex items-center cursor-pointer relative group/toggle" title="Activar/Desactivar">
                            <input type="checkbox" onchange="updateProduct('${p.id}', 'activo', this.checked)" class="sr-only peer" ${isActive ? 'checked' : ''}>
                            <div class="w-7 h-4 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-green-500"></div>
                        </label>
                    </td>
                    <td class="p-1 text-center align-middle">
                        <button onclick="deleteProduct('${p.id}')" class="text-gray-300 hover:text-red-500 p-1 transition opacity-0 group-hover:opacity-100" title="Eliminar">
                            <i class="fa-solid fa-trash text-xs"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.previewImage = (url) => {
            const box = document.getElementById('imgPreviewBox');
            const img = document.getElementById('imgPreview');
            if(url && url.length > 10) {
                box.classList.remove('hidden');
                img.src = url;
                img.onerror = () => box.classList.add('hidden');
            } else { box.classList.add('hidden'); }
        }

        async function uploadProduct() {
            if (!currentUser) return showToast("Error Sesión", "error");
            
            const name = document.getElementById('prodName').value;
            const cat = document.getElementById('prodCat').value;
            const url = document.getElementById('prodFile').value;
            const pcs = document.getElementById('prodPcs').value;
            const btn = document.getElementById('btnUpload');
            
            if(!name || !url) return showToast("Faltan datos", "error");
            
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;

            try {
                await db.ref('productos').push({
                    name, 
                    category: cat, 
                    image: url,
                    piezas: pcs,
                    activo: true, 
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
                showToast("Guardado", "success");
                
                document.getElementById('prodName').value = "";
                document.getElementById('prodCat').value = "";
                document.getElementById('prodFile').value = "";
                document.getElementById('prodPcs').value = "";
                document.getElementById('imgPreviewBox').classList.add('hidden');
                document.getElementById('prodName').focus(); // Foco rápido para seguir agregando
            } catch(e) { showToast(e.message, "error"); } 
            finally { btn.disabled = false; btn.innerHTML = originalText; }
        }

        window.updateProduct = async (id, field, val, inputElement) => {
            if(!currentUser) return;
            if(inputElement) inputElement.classList.add('bg-yellow-50');

            try {
                await db.ref('productos/'+id).update({[field]: val});
                if(inputElement) {
                    inputElement.classList.replace('bg-yellow-50', 'bg-green-50');
                    setTimeout(() => inputElement.classList.remove('bg-green-50'), 500);
                }
            } catch(e) { 
                showToast("Error", "error");
                if(inputElement) inputElement.classList.add('bg-red-50');
            }
        };

        window.deleteProduct = async (id) => {
            if(!currentUser) return;
            if(confirm("¿Eliminar?")) {
                try {
                    await db.ref('productos/'+id).remove();
                    showToast("Eliminado", "success");
                } catch(e) { showToast("Error", "error"); }
            }
        };

        let toastTimeout;
        function showToast(msg, type = "success") {
            const t = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            document.getElementById('toast-msg').innerText = msg;
            
            if(type === 'error') {
                t.classList.replace('border-indigo-500', 'border-red-500');
                icon.className = "fa-solid fa-xmark text-red-500";
            } else {
                t.classList.replace('border-red-500', 'border-indigo-500');
                icon.className = "fa-solid fa-check text-green-400";
            }
            t.classList.remove('translate-y-24');
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => t.classList.add('translate-y-24'), 2000);
        }

        window.uploadProduct = uploadProduct;
    </script>
</body>
</html>
